apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-service
  namespace: default
  labels:
    app: api-service
spec:
  # Desired state: maintain exactly 1 running Pod.
  # If the Pod crashes, the ReplicaSet controller will spawn a new one to match this number.
  # For high availability, this would usually be >1.
  replicas: 1
  selector:
    # Label selector: Determines which Pods belong to this Deployment.
    # Must match the labels defined in the pod template below.
    matchLabels:
      app: api-service
  template:
    metadata:
      labels:
        app: api-service
    spec:
      containers:
        - name: api-service
          # The Docker image to run.
          image: api-service:local
          # "Never" forces Kubelet to use the local container runtime's image cache.
          # Required for k3d because the image isn't in a remote registry (like DockerHub).
          imagePullPolicy: Never
          ports:
            - containerPort: 3000
          env:
            - name: PORT
              value: "3000"
            - name: HOST
              value: "0.0.0.0"
---
apiVersion: v1
kind: Service
metadata:
  name: api-service
  namespace: default
spec:
  # Service Discovery: routes traffic to Pods matching this selector.
  selector:
    app: api-service 
  ports:
    - protocol: TCP
      # The stable port exposed by this Service IP.
      # Other pods access this service via api-service:3000
      port: 3000
      # The actual listening port on the target Pod container.
      targetPort: 3000
  # LoadBalancer: Requests a public IP from the Cloud Provider (or k3d host).
  # This allows traffic to reach the Service from outside the cluster.
  type: LoadBalancer
